# Qdenzo Network ‚Äî Telegram Bot (prod-ready)

–ü–æ–ª–Ω–æ—Å—Ç—å—é –ø–µ—Ä–µ–ø–∏—Å–∞–Ω–Ω—ã–π –±–æ—Ç –ø–æ–¥ –ø—Ä–æ–¥–∞—à–µ–Ω‚Äë–∑–∞–ø—É—Å–∫ –∏ –ø–µ—Ä–≤–∏—á–Ω—ã–π —Ç–µ—Å—Ç.

## –ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

- aiogram 3, HTML parse mode, –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–æ–≤ (–±–µ–∑ `can't parse entities`)
- Postgres + Redis –≤ `docker-compose`
- –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (—á–∏–Ω—è—Ç —Ç–∏–ø–æ–≤—É—é –ø—Ä–æ–±–ª–µ–º—É `column ... does not exist` –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ö–µ–º—ã)
- –ü–æ–¥–ø–∏—Å–∫–∏:
  - Trial: 48 —á–∞—Å–æ–≤, 1 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  - Start: 1/3/6/12 –º–µ—Å (3 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞) ‚Äî 249/499/999/1999 ‚ÇΩ
  - Pro: 1/3/6/12 –º–µ—Å (5 —É—Å—Ç—Ä–æ–π—Å—Ç–≤) ‚Äî 399/899/1399/2499 ‚ÇΩ
  - Family: 3/6/12 –º–µ—Å (10 —É—Å—Ç—Ä–æ–π—Å—Ç–≤) ‚Äî 1099/1599/2999 ‚ÇΩ
- –£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: 1 —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ = 1 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å Marzban, –≤—ã–¥–∞—á–∞ —Å—Å—ã–ª–∫–∏ (link/subscription)
- –ü—Ä–æ—Ñ–∏–ª–∏ (—Ä–µ–∂–∏–º—ã): Smart / Streaming / Gaming / Work / Low Internet / Kids
- –¢—Ä–∞—Ñ–∏–∫: –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å—É–º–º–∞—Ä–Ω—ã–π used_traffic –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º (—á–µ—Ä–µ–∑ Marzban API) + –ª–∏–º–∏—Ç –∏–∑ `.env`
- –†–µ—Ñ–µ—Ä–∞–ª–∫–∞: –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø–æ —Ç–∞–±–ª–∏—Ü–µ –∏–∑ –¢–ó, –∫–∞–ø 15 –¥–Ω–µ–π –Ω–∞ 30 –¥–Ω–µ–π, –ø–æ–¥–¥–µ—Ä–∂–∞–Ω –æ—Ç–∫–∞—Ç (refund)
- –ê–¥–º–∏–Ω‚Äë–ø–∞–Ω–µ–ª—å –≤ –±–æ—Ç–µ: —Å–ø–∏—Å–æ–∫ pending‚Äë–∑–∞–∫–∞–∑–æ–≤, approve/cancel

## –ë—ã—Å—Ç—Ä—ã–π –∑–∞–ø—É—Å–∫ (Docker)

1) –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Å–µ—Ä–≤–µ—Ä, –Ω–∞–ø—Ä–∏–º–µ—Ä –≤ `/opt/qdenzo-bot`:

```bash
mkdir -p /opt/qdenzo-bot
cd /opt/qdenzo-bot
# —Ä–∞—Å–ø–∞–∫—É–π—Ç–µ –∞—Ä—Ö–∏–≤ —Å—é–¥–∞
```

2) –°–æ–∑–¥–∞–π—Ç–µ `.env`:

```bash
cp .env.example .env
nano .env
```

–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å:
- `BOT_TOKEN`
- `ADMIN_IDS`
- `DATABASE_URL`
- `MARZBAN_BASE_URL`, `MARZBAN_USERNAME`, `MARZBAN_PASSWORD`

3) –ó–∞–ø—É—Å—Ç–∏—Ç–µ:

```bash
docker compose up -d --build
```

4) –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏:

```bash
docker compose logs -f bot
```

## –ó–∞–ø—É—Å–∫ –≤ –ø—Ä–æ–¥–µ

1) –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ HTTPS –¥–æ–º–µ–Ω—É –∏ —É–∫–∞–∂–∏—Ç–µ –µ–≥–æ –≤ `.env`:

```
PUBLIC_BASE_URL=https://your-domain.com
```

2) –ü–æ–¥–Ω–∏–º–∏—Ç–µ reverse proxy (nginx/caddy) –∏ –ø—Ä–æ–∫–∏–Ω—å—Ç–µ HTTPS –Ω–∞ –ø–æ—Ä—Ç `8080` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

3) –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ –≤–µ–±—Ö—É–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã:

```
https://your-domain.com/webhook/yookassa/<YOOKASSA_WEBHOOK_PATH_SECRET>
https://your-domain.com/webhook/cryptopay/<CRYPTOPAY_WEBHOOK_PATH_SECRET>
```

## –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Webhooks

### YooKassa (–°–ë–ü/–∫–∞—Ä—Ç–∞)

1) –°–æ–∑–¥–∞–π—Ç–µ API-–∫–ª—é—á –∏ —É–∫–∞–∂–∏—Ç–µ:
   - `YOOKASSA_SHOP_ID`
   - `YOOKASSA_SECRET_KEY`
   - `YOOKASSA_RETURN_URL`
   - `YOOKASSA_WEBHOOK_PATH_SECRET`
2) –í –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ YooKassa –¥–æ–±–∞–≤—å—Ç–µ webhook `payment.succeeded` –Ω–∞:
   ```
   https://<domain>/webhook/yookassa/<YOOKASSA_WEBHOOK_PATH_SECRET>
   ```

### Crypto Pay (@CryptoBot)

1) –°–æ–∑–¥–∞–π—Ç–µ —Ç–æ–∫–µ–Ω –∏ —É–∫–∞–∂–∏—Ç–µ:
   - `CRYPTOPAY_TOKEN`
   - `CRYPTOPAY_ASSET`
   - `CRYPTOPAY_WEBHOOK_PATH_SECRET`
   - `CRYPTOPAY_WEBHOOK_SECRET`
2) –í –∫–∞–±–∏–Ω–µ—Ç–µ CryptoBot —É–∫–∞–∂–∏—Ç–µ webhook:
   ```
   https://<domain>/webhook/cryptopay/<CRYPTOPAY_WEBHOOK_PATH_SECRET>
   ```

### Telegram Stars

1) –í–∫–ª—é—á–∏—Ç–µ `TG_STARS_ENABLED=true`.
2) –ó–∞–¥–∞–π—Ç–µ —Ü–µ–Ω—ã Stars –≤ `.env` (–Ω–∞–ø—Ä–∏–º–µ—Ä `STARS_PRICE_START_1=...`).

### –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–ø–ª–∞—Ç—ã

–ù–∞ —ç–∫—Ä–∞–Ω–µ –æ–ø–ª–∞—Ç—ã –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∞ ¬´üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–ø–ª–∞—Ç—É¬ª. –û–Ω–∞ –æ–±—Ä–∞—â–∞–µ—Ç—Å—è –∫ YooKassa/CryptoPay –Ω–∞–ø—Ä—è–º—É—é –∏ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç –ø–æ–¥–ø–∏—Å–∫—É –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏.

## –ö–∞–∫ –∑–∞–π—Ç–∏ –≤ Postgres

```bash
docker compose exec db psql -U $POSTGRES_USER -d $POSTGRES_DB
\dt
```

## –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –≤–µ—Ä—Å–∏–π (–µ—Å–ª–∏ –Ω–∞–¥–æ)

‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –∫–æ–º–∞–Ω–¥—ã –Ω–∏–∂–µ —É–¥–∞–ª—è—é—Ç volume Postgres –∏ —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.

### –í–∞—Ä–∏–∞–Ω—Ç 1 (—Å–∞–º—ã–π –ø—Ä–æ—Å—Ç–æ–π)

–í –∫–∞—Ç–∞–ª–æ–≥–µ —Ç–µ–∫—É—â–µ–≥–æ –±–æ—Ç–∞:

```bash
docker compose down -v --remove-orphans
```

### –í–∞—Ä–∏–∞–Ω—Ç 2 (–µ—Å–ª–∏ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ –æ—Å—Ç–∞–ª–∏—Å—å —Å—Ç–∞—Ä—ã–µ –ø—Ä–æ–µ–∫—Ç—ã/–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã)

```bash
bash scripts/cleanup_old_bot.sh
```

## –û–ø–ª–∞—Ç—ã

–°–µ–π—á–∞—Å –ø—Ä–æ–¥‚Äë—Ç–µ—Å—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω –Ω–∞ —Ä—É—á–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω–æ–º.

–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ —É–∂–µ —Å–µ–π—á–∞—Å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –æ–ø–ª–∞—Ç—É ¬´—Å—Å—ã–ª–∫–æ–π¬ª, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ:
- `YOOKASSA_PAY_URL` ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –∫–∞—Ä—Ç–æ–π/–°–ë–ü (–ª—é–±–∞—è –≤–∞—à–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–∞/–∏–Ω–≤–æ–π—Å)
- `CRYPTO_PAY_URL` ‚Äî —Å—Å—ã–ª–∫–∞ –Ω–∞ –æ–ø–ª–∞—Ç—É –∫—Ä–∏–ø—Ç–æ–π

–î–∞–ª—å—à–µ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –≤–µ–±—Ö—É–∫–∏ YooKassa / Stars (Telegram) –æ—Ç–¥–µ–ª—å–Ω—ã–º —Å–µ—Ä–≤–∏—Å–æ–º.
